CREATE OR REPLACE TEMP TABLE TMP_CDA AS
SELECT
      OBSRVTN.SRC_ENCNTR_ID,
      P01_protegrity.scrty_acs_cntrl.ANTM_AES256_DETOK(
            OBSRVTN.OBSRVTN_VAL_TXT
      ) AS CDA_OBSRVTN_VAL_TXT,
      PAT.MCID,
      PAT.RCRD_AUTHRTY_NM,
      OBSRVTN.CODE AS CDA_CODE,
      OBSRVTN.EDL_RUN_ID,
      OBSRVTN.SRC_NM
FROM P01_CDA.CDA_ALLPHI.OBSRVTN OBSRVTN
INNER JOIN P01_CDA.CDA_ALLPHI.PAT PAT
      ON PAT.PAT_GUID = OBSRVTN.PAT_GUID
GROUP BY ALL;

CREATE OR REPLACE TEMP TABLE TMP_HOSCDA AS
SELECT 
      OBSRVTN.OBSRVTN_VAL_TXT               AS HOSCDA_OBSRVTN_VAL_TXT,
      OBSRVTN.obsrvtn_val_type_nm,
      VAL_CD.OBSRVTN_DSPLY_TXT              AS HOSCDA_DISPLAY_TXT,
      VAL_CD.ORGLN_TXT                      AS HOSCDA_ORIGINAL_TXT,
      ENCNTR_ID.val_txt                     AS SRC_ENCNTR_ID,
      PAT.MCID,
      PAT.RCRD_AUTHRTY_NM,
      VAL_CD.CD_TRNSLTNG_ID                 AS HOSCDA_CODE,
      OBSRVTN.EDL_RUN_ID,
      OBSRVTN.SRC_NM
FROM HOSCDA_STG.HLTH_OS_CDA_OBSRVTN_STG OBSRVTN
INNER JOIN HOSCDA_STG.HLTH_OS_CDA_OBSRVTN_CD_RFRNC_STG OBSRVTN_CD
      ON OBSRVTN.obsrvtn_id = OBSRVTN_CD.RSRC_ID
     AND OBSRVTN.EDL_RUN_ID = OBSRVTN_CD.EDL_RUN_ID
INNER JOIN HOSCDA_STG.HLTH_OS_CDA_ENCNTR_ID_RFRNC_STG ENCNTR_ID
      ON SPLIT_PART(OBSRVTN.ENCNTR_RFRNC_TXT,'^',2) = ENCNTR_ID.RSRC_ID
     AND OBSRVTN.EDL_RUN_ID = ENCNTR_ID.EDL_RUN_ID
INNER JOIN HOSCDA_STG.HLTH_OS_CDA_OBSRVTN_CD_RFRNC_STG VAL_CD
      ON OBSRVTN.obsrvtn_id = VAL_CD.RSRC_ID
     AND OBSRVTN.EDL_RUN_ID = VAL_CD.EDL_RUN_ID
INNER JOIN HOSCDA_EXTRACT.PAT_ANTHM_ID PAT
      ON SPLIT_PART(OBSRVTN.subj_rfrnc_txt, '^', 2) = PAT.PAT_GUID
WHERE TRIM(OBSRVTN.OBSRVTN_VAL_TXT) <> ''
  AND OBSRVTN.obsrvtn_val_type_nm = 'CD'
  AND VAL_CD.CD_TRNSLTNG_ID IS NOT NULL
GROUP BY ALL;

CREATE OR REPLACE TEMP TABLE TMP_PROC AS
SELECT 
    proc_cd.PROC_CD,
    proc_cda.EDL_RUN_ID,
    proc_cda.PROC_ID,
    proc_cda.SRC_NM_TXT
FROM HLTH_OS_CDA_PROC proc_cda
JOIN HLTH_OS_CDA_PROC_CD_RFRNC proc_cd
    ON proc_cda.EDL_RUN_ID = proc_cd.EDL_RUN_ID
   AND proc_cda.PROC_ID = proc_cd.RSRC_ID;

SELECT 
    COALESCE(CDA.SRC_ENCNTR_ID, H.SRC_ENCNTR_ID)       AS SRC_ENCNTR_ID,
    COALESCE(CDA.MCID, H.MCID)                         AS MCID,

    -- CDA
    CDA.CDA_OBSRVTN_VAL_TXT,
    CDA.CDA_CODE,

    -- HOSCDA
    H.HOSCDA_OBSRVTN_VAL_TXT,
    H.HOSCDA_CODE,
    H.HOSCDA_DISPLAY_TXT,
    H.HOSCDA_ORIGINAL_TXT,

    -- PROC CODE (optional)
    P.PROC_CD,

    -- MATCH FLAGS
    CASE WHEN CDA.CDA_OBSRVTN_VAL_TXT = H.HOSCDA_OBSRVTN_VAL_TXT 
         THEN 'MATCH' ELSE 'MISMATCH' END AS VALUE_MATCH,

    CASE WHEN CDA.CDA_CODE = H.HOSCDA_CODE 
         THEN 'MATCH' ELSE 'MISMATCH' END AS CODE_MATCH

FROM TMP_CDA CDA
FULL OUTER JOIN TMP_HOSCDA H
      ON CDA.SRC_ENCNTR_ID = H.SRC_ENCNTR_ID
     AND CDA.MCID = H.MCID
     AND CDA.CDA_CODE = H.HOSCDA_CODE
LEFT JOIN TMP_PROC P
      ON P.EDL_RUN_ID = H.EDL_RUN_ID
     AND P.SRC_NM_TXT = H.SRC_NM;




